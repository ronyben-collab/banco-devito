<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Banco Devito</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{
  background:#0b0b0b;
  color:white;
  font-family:Arial;
  padding:15px;
}
.card{
  background:#141414;
  border:1px solid #333;
  border-radius:10px;
  padding:15px;
  margin-bottom:15px;
}
input,button{
  width:100%;
  padding:10px;
  margin-top:8px;
  border-radius:6px;
  border:none;
}
button{
  background:#1e90ff;
  color:white;
  font-weight:bold;
  cursor:pointer;
}
.hidden{display:none}
.green{color:#00ff7f}
.red{color:#ff5c5c}
.item{border-bottom:1px solid #333;padding:8px 0}
</style>
</head>
<body>

<h2>ğŸ¦ Banco Devito (Juego Nuevo)</h2>

<!-- LOGIN -->
<div id="loginBox" class="card">
  <input id="email" placeholder="Correo">
  <input id="pass" type="password" placeholder="ContraseÃ±a">
  <button onclick="login()">Iniciar sesiÃ³n</button>
  <button onclick="register()">Crear cuenta</button>
</div>

<!-- BANCO -->
<div id="bankBox" class="hidden">

<div class="card">
  <b>Saldo:</b> <span id="saldo">0</span><br>
  <b>Tarjeta:</b> <span id="tarjeta">---</span><br>
  <b>Score:</b> <span id="score">50</span>
</div>

<!-- ENVIAR -->
<div class="card">
  <h3>ğŸ’¸ Enviar dinero</h3>
  <input id="destino" placeholder="DEV-XXXXXX">
  <input id="monto" type="number" placeholder="Monto">
  <button onclick="enviar()">Enviar</button>
</div>

<!-- PRESTAMO ENTRE JUGADORES -->
<div class="card">
  <h3>ğŸ¤ PrÃ©stamo a jugador</h3>
  <input id="prestTarjeta" placeholder="DEV-XXXXXX">
  <input id="prestMonto" type="number" placeholder="Monto">
  <label>
    <input type="checkbox" id="prestInteres"> Aplicar intereses
  </label>
  <button onclick="prestamoJugador()">Prestar</button>
</div>

<!-- PRESTAMO BANCO -->
<div class="card">
  <h3>ğŸ¦ PrÃ©stamo del banco</h3>
  <input id="bancoMonto" type="number" placeholder="Monto solicitado">
  <button onclick="prestamoBanco()">Solicitar</button>
</div>

<!-- PRESTAMOS -->
<div class="card">
  <h3>ğŸ“‘ PrÃ©stamos</h3>
  <div id="prestamos"><i>Sin prÃ©stamos</i></div>
</div>

<!-- HISTORIAL -->
<div class="card">
  <h3>ğŸ“„ Historial</h3>
  <div id="historial"><i>VacÃ­o</i></div>
  <button onclick="borrarHistorial()">Borrar historial</button>
</div>

<button onclick="logout()">Cerrar sesiÃ³n</button>
<button onclick="eliminarCuenta()" style="background:#ff4d4d">Eliminar cuenta</button>

</div>

<script>
// ğŸ”¹ FIREBASE (MISMO PROYECTO)
firebase.initializeApp({
  apiKey: "AIzaSyDeUQx95EfJgmNeyh_L2Cnzqmm37emwJhw",
  authDomain: "bancodevito.firebaseapp.com",
  databaseURL: "https://bancodevito-default-rtdb.firebaseio.com",
  projectId: "bancodevito"
});

const auth = firebase.auth();
const db = firebase.database();

let cuenta="", tarjeta="", scoreActual=50;

// ğŸ”¹ SESIÃ“N
auth.onAuthStateChanged(u=>{
  if(u){
    loginBox.classList.add("hidden");
    bankBox.classList.remove("hidden");
    cargarUsuario(u.uid);
  }else{
    loginBox.classList.remove("hidden");
    bankBox.classList.add("hidden");
  }
});

// ğŸ”¹ LOGIN / REGISTER
function login(){
  auth.signInWithEmailAndPassword(email.value, pass.value)
  .catch(e=>alert(e.message));
}

function register(){
  auth.createUserWithEmailAndPassword(email.value, pass.value)
  .then(r=>{
    const uid = r.user.uid;
    cuenta = "CUENTA-" + Math.floor(Math.random()*900000+100000);
    tarjeta = "DEV-" + Math.floor(Math.random()*900000+100000);

    db.ref("usuarios/"+uid).set({
      cuenta: cuenta,
      score: 50
    });

    db.ref("cuentas/"+cuenta).set({
      saldo: 1000,
      totalRecibido: 0
    });

    db.ref("tarjetas/"+tarjeta).set({
      cuenta: cuenta
    });

    alert("Cuenta creada. Juego nuevo iniciado.");
  });
}

// ğŸ”¹ CARGAR USUARIO
function cargarUsuario(uid){
  db.ref("usuarios/"+uid).once("value").then(s=>{
    cuenta = s.val().cuenta;
    scoreActual = s.val().score;
    score.innerText = scoreActual;

    db.ref("cuentas/"+cuenta+"/saldo")
      .on("value",v=>saldo.innerText=v.val()||0);

    db.ref("tarjetas")
      .orderByChild("cuenta")
      .equalTo(cuenta)
      .once("value")
      .then(r=>r.forEach(x=>tarjeta.innerText=x.key));

    cargarPrestamos();
    cargarHistorial();
  });
}

// ğŸ”¹ ENVIAR DINERO
function enviar(){
  const d = destino.value;
  const m = parseInt(monto.value);
  if(!d||!m) return;

  db.ref("tarjetas/"+d).once("value").then(t=>{
    if(!t.exists()) return alert("Tarjeta invÃ¡lida");

    moverSaldo(t.val().cuenta, m, "EnvÃ­o");
  });
}

function moverSaldo(dest, m, desc){
  db.ref("cuentas/"+cuenta+"/saldo").once("value").then(s=>{
    if(s.val() < m) return alert("Saldo insuficiente");

    db.ref("cuentas/"+cuenta+"/saldo").set(s.val()-m);
    db.ref("cuentas/"+dest+"/saldo").transaction(v=>(v||0)+m);
    guardarHistorial(desc, m);
  });
}

// ğŸ”¹ PRESTAMO ENTRE JUGADORES
function prestamoJugador(){
  const d = prestTarjeta.value;
  const m = parseInt(prestMonto.value);
  const conInteres = prestInteres.checked;
  if(!d||!m) return;

  db.ref("tarjetas/"+d).once("value").then(t=>{
    if(!t.exists()) return alert("Jugador invÃ¡lido");

    let interes = conInteres ? (m<=500?0.04:m<=1000?0.07:0.10) : 0;
    let dias = m<=300?3:m<=700?7:m<=1500?14:30;
    let deuda = Math.floor(m*(1+interes));

    moverSaldo(t.val().cuenta, m, "PrÃ©stamo a jugador");

    db.ref("prestamos/"+t.val().cuenta).push({
      de: cuenta,
      monto: m,
      deuda: deuda,
      dias: dias,
      inicio: Date.now(),
      pagado: false
    });

    alert("PrÃ©stamo concedido");
  });
}

// ğŸ”¹ PRESTAMO BANCO
function prestamoBanco(){
  const m = parseInt(bancoMonto.value);
  if(!m) return;

  const max = scoreActual * 20;
  if(m > max) return alert("No aprobado por score");

  let interes = m<=500?0.05:m<=1000?0.08:0.12;
  let dias = m<=300?3:m<=700?7:m<=1500?14:30;
  let deuda = Math.floor(m*(1+interes));

  db.ref("cuentas/"+cuenta+"/saldo").transaction(v=>(v||0)+m);

  db.ref("prestamos/"+cuenta).push({
    de:"BANCO",
    monto:m,
    deuda:deuda,
    dias:dias,
    inicio:Date.now(),
    pagado:false
  });

  guardarHistorial("PrÃ©stamo banco", m);
}

// ğŸ”¹ PRESTAMOS
function cargarPrestamos(){
  prestamos.innerHTML="";
  db.ref("prestamos/"+cuenta).once("value").then(s=>{
    if(!s.exists()){
      prestamos.innerHTML="<i>Sin prÃ©stamos</i>";
      return;
    }
    Object.entries(s.val()).forEach(([id,p])=>{
      prestamos.innerHTML+=`
      <div class="item">
        De: ${p.de}<br>
        Total: ${p.deuda}<br>
        Estado: ${p.pagado?'<span class="green">Pagado</span>':'<span class="red">Activo</span>'}
        ${!p.pagado?`<button onclick="pagar('${id}',${p.deuda})">Pagar</button>`:""}
      </div>`;
    });
  });
}

function pagar(id,m){
  db.ref("cuentas/"+cuenta+"/saldo").once("value").then(s=>{
    if(s.val()<m) return alert("Saldo insuficiente");
    db.ref("cuentas/"+cuenta+"/saldo").set(s.val()-m);
    db.ref("prestamos/"+cuenta+"/"+id+"/pagado").set(true);
    scoreActual+=5;
    score.innerText=scoreActual;
    guardarHistorial("Pago prÃ©stamo", m);
    cargarPrestamos();
  });
}

// ğŸ”¹ HISTORIAL
function guardarHistorial(d,m){
  db.ref("historial/"+cuenta).push({desc:d,m,fecha:Date.now()});
  cargarHistorial();
}

function cargarHistorial(){
  historial.innerHTML="";
  db.ref("historial/"+cuenta).once("value").then(s=>{
    if(!s.exists()){
      historial.innerHTML="<i>VacÃ­o</i>";
      return;
    }
    Object.values(s.val()).reverse().forEach(x=>{
      historial.innerHTML+=`<div class="item">${x.desc} - ${x.m}</div>`;
    });
  });
}

function borrarHistorial(){
  if(confirm("Â¿Borrar historial?")){
    db.ref("historial/"+cuenta).remove();
    historial.innerHTML="<i>VacÃ­o</i>";
  }
}

// ğŸ”¹ LOGOUT / DELETE
function logout(){ auth.signOut(); }

function eliminarCuenta(){
  if(!confirm("Eliminar cuenta definitivamente?")) return;
  const u = auth.currentUser;
  db.ref("usuarios/"+u.uid).remove();
  db.ref("cuentas/"+cuenta).remove();
  db.ref("prestamos/"+cuenta).remove();
  db.ref("historial/"+cuenta).remove();
  db.ref("tarjetas/"+tarjeta).remove();
  u.delete().then(()=>alert("Cuenta eliminada"));
}
</script>

</body>
</html>
