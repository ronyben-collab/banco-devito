<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Banco Devito</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{background:#0b0b0b;color:#fff;font-family:Arial;margin:0;padding:15px}
.card{border:1px solid #333;border-radius:10px;padding:15px;margin-bottom:15px}
input,button{width:100%;padding:10px;margin-top:8px;border-radius:6px;border:none}
button{background:#1e90ff;color:white;font-weight:bold}
.red{color:#ff5c5c}
.green{color:#00ff7f}
.hidden{display:none}
</style>
</head>
<body>

<h2>üè¶ Banco Devito</h2>

<!-- LOGIN -->
<div id="loginBox" class="card">
  <input id="email" placeholder="Correo">
  <input id="pass" type="password" placeholder="PIN">
  <button onclick="login()">Iniciar sesi√≥n</button>
  <button onclick="register()">Crear cuenta</button>
</div>

<!-- BANCO -->
<div id="bankBox" class="hidden">

  <div class="card">
    <b>Saldo:</b> <span id="saldo">0</span> coins<br>
    <b>Score:</b> <span id="score">50</span>
  </div>

  <!-- ENVIAR -->
  <div class="card">
    <h3>Enviar dinero</h3>
    <input id="destino" placeholder="DEV-XXXXXX">
    <input id="monto" type="number" placeholder="Monto">
    <button onclick="enviar()">Enviar</button>
  </div>

  <!-- PR√âSTAMO BANCO -->
  <div class="card">
    <h3>Pr√©stamo del banco</h3>
    <input id="montoPrestamo" type="number" placeholder="Monto">
    <button onclick="pedirPrestamo()">Solicitar pr√©stamo</button>
    <div id="prestamos"></div>
  </div>

  <!-- TIENDA -->
  <div class="card">
    <h3>üõí Tienda</h3>
    <div id="tienda"></div>
  </div>

  <!-- HISTORIAL -->
  <div class="card">
    <h3>üìú Historial</h3>
    <div id="historial"></div>
  </div>

  <button onclick="logout()">Cerrar sesi√≥n</button>
  <button onclick="eliminarCuenta()" style="background:#ff1e1e">Eliminar cuenta</button>
</div>

<script>
// FIREBASE
firebase.initializeApp({
  apiKey:"AIzaSyDeUQx95EfJgmNeyh_L2Cnzqmm37emwJhw",
  authDomain:"bancodevito.firebaseapp.com",
  databaseURL:"https://bancodevito-default-rtdb.firebaseio.com",
  projectId:"bancodevito"
});

const auth=firebase.auth();
const db=firebase.database();
let uid="", cuenta="", scoreActual=50;

// SESI√ìN
auth.onAuthStateChanged(u=>{
  if(u){
    uid=u.uid;
    loginBox.classList.add("hidden");
    bankBox.classList.remove("hidden");
    cargarUsuario();
  }else{
    loginBox.classList.remove("hidden");
    bankBox.classList.add("hidden");
  }
});

function login(){
  auth.signInWithEmailAndPassword(email.value,pass.value)
  .catch(e=>alert(e.message));
}

function register(){
  auth.createUserWithEmailAndPassword(email.value,pass.value).then(r=>{
    uid=r.user.uid;
    cuenta="DEV-"+Math.floor(100000+Math.random()*900000);
    db.ref("usuarios/"+uid).set({
      cuenta, saldo:1000, score:50
    });
  }).catch(e=>alert(e.message));
}

// CARGAR
function cargarUsuario(){
  db.ref("usuarios/"+uid).on("value",s=>{
    if(!s.exists()) return;
    cuenta=s.val().cuenta;
    saldo.innerText=s.val().saldo;
    scoreActual=s.val().score;
    score.innerText=scoreActual;
  });
  cargarHistorial();
  cargarPrestamos();
  cargarTienda();
}

// ENVIAR
function enviar(){
  let d=destino.value;
  let m=parseInt(monto.value);
  if(!d||!m) return alert("Datos incompletos");

  db.ref("usuarios/"+uid).once("value").then(s=>{
    if(s.val().saldo<m) return alert("Saldo insuficiente");
    db.ref("usuarios/"+uid+"/saldo").set(s.val().saldo-m);
    db.ref("historial/"+uid).push("Enviaste "+m+" coins a "+d);
    destino.value=""; monto.value="";
  });
}

// PR√âSTAMOS BANCO
function pedirPrestamo(){
  let m=parseInt(montoPrestamo.value);
  if(!m) return alert("Monto inv√°lido");
  if(scoreActual<30) return alert("Score muy bajo");

  let interes= scoreActual>=80 ? 0.05 : scoreActual>=50 ? 0.1 : 0.2;
  let total=Math.floor(m+(m*interes));

  db.ref("usuarios/"+uid).once("value").then(s=>{
    db.ref("usuarios/"+uid+"/saldo").set(s.val().saldo+m);
    db.ref("prestamos/"+uid).push({
      monto:m,total, pagado:false
    });
    db.ref("historial/"+uid).push("Pr√©stamo banco "+m+" (Total "+total+")");
  });
}

// PAGAR PR√âSTAMO
function pagar(id,total){
  db.ref("usuarios/"+uid).once("value").then(s=>{
    if(s.val().saldo<total) return alert("No alcanza");
    db.ref("usuarios/"+uid+"/saldo").set(s.val().saldo-total);
    db.ref("prestamos/"+uid+"/"+id+"/pagado").set(true);
    db.ref("usuarios/"+uid+"/score").set(Math.min(100,scoreActual+5));
  });
}

function cargarPrestamos(){
  db.ref("prestamos/"+uid).on("value",s=>{
    prestamos.innerHTML="";
    s.forEach(p=>{
      let d=p.val();
      prestamos.innerHTML+=`
      <div>
      Pr√©stamo ${d.monto} ‚Üí ${d.total}
      ${d.pagado?"<span class='green'>Pagado</span>":
      `<button onclick="pagar('${p.key}',${d.total})">Pagar</button>`}
      </div>`;
    });
  });
}

// HISTORIAL
function cargarHistorial(){
  db.ref("historial/"+uid).on("value",s=>{
    historial.innerHTML="";
    s.forEach(h=>{
      historial.innerHTML="<div>"+h.val()+"</div>"+historial.innerHTML;
    });
  });
}

// TIENDA
function cargarTienda(){
  tienda.innerHTML=`
  <div>
    Skin Minecraft - 200 coins
    <button onclick="comprar(200,'Skin Minecraft')">Comprar</button>
  </div>
  <div>
    Brainrot exclusivo - 300 coins
    <button onclick="comprar(300,'Brainrot')">Comprar</button>
  </div>`;
}

function comprar(p,n){
  db.ref("usuarios/"+uid).once("value").then(s=>{
    if(s.val().saldo<p) return alert("No alcanza");
    db.ref("usuarios/"+uid+"/saldo").set(s.val().saldo-p);
    db.ref("historial/"+uid).push("Compraste "+n+" por "+p);
  });
}

// CUENTA
function logout(){auth.signOut();}
function eliminarCuenta(){
  if(!confirm("¬øEliminar cuenta?")) return;
  db.ref("usuarios/"+uid).remove();
  db.ref("historial/"+uid).remove();
  db.ref("prestamos/"+uid).remove();
  auth.currentUser.delete();
}
</script>
</body>
</html>
