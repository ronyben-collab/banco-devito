<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Banco Devito</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{background:#0b0b0b;color:white;font-family:Arial;padding:15px}
.card{background:#141414;border:1px solid #333;border-radius:10px;padding:15px;margin-bottom:15px}
input,button{width:100%;padding:10px;margin-top:8px;border-radius:6px;border:none}
button{background:#1e90ff;color:white;font-weight:bold;cursor:pointer}
.hidden{display:none}
.green{color:#00ff7f}
.red{color:#ff5c5c}
.item{border-bottom:1px solid #333;padding:8px 0}
</style>
</head>
<body>

<h2>üè¶ Banco Devito</h2>

<div id="loginBox" class="card">
  <input id="email" placeholder="Correo">
  <input id="pass" type="password" placeholder="Contrase√±a">
  <button onclick="login()">Iniciar sesi√≥n</button>
  <button onclick="register()">Crear cuenta</button>
</div>

<div id="bankBox" class="hidden">

<div class="card">
  <b>Saldo:</b> <span id="saldo">0</span><br>
  <b>Tarjeta:</b> <span id="tarjeta">---</span><br>
  <b>Score:</b> <span id="score">50</span>
</div>

<div class="card">
  <h3>üí∏ Enviar dinero</h3>
  <input id="destino" placeholder="DEV-XXXXXX">
  <input id="monto" type="number" placeholder="Monto">
  <button onclick="enviar()">Enviar</button>
</div>

<div class="card">
  <h3>üè¶ Pr√©stamo banco</h3>
  <input id="bancoMonto" type="number" placeholder="Monto">
  <button onclick="prestamoBanco()">Solicitar</button>
</div>

<div class="card">
  <h3>üìë Pr√©stamos</h3>
  <div id="prestamos"></div>
</div>

<div class="card">
  <h3>üìÑ Historial</h3>
  <div id="historial"></div>
  <button onclick="borrarHistorial()">Borrar historial</button>
</div>

<button onclick="logout()">Cerrar sesi√≥n</button>
<button onclick="eliminarCuenta()" style="background:#ff4d4d">Eliminar cuenta</button>

</div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyDeUQx95EfJgmNeyh_L2Cnzqmm37emwJhw",
  authDomain: "bancodevito.firebaseapp.com",
  databaseURL: "https://bancodevito-default-rtdb.firebaseio.com",
  projectId: "bancodevito"
});

const auth = firebase.auth();
const db = firebase.database();

let uidActual = null;
let cuenta = null;
let tarjeta = null;
let scoreActual = 50;

// SESI√ìN
auth.onAuthStateChanged(user=>{
  if(user){
    uidActual = user.uid;
    loginBox.classList.add("hidden");
    bankBox.classList.remove("hidden");
    cargarDatos();
  }else{
    uidActual = null;
    loginBox.classList.remove("hidden");
    bankBox.classList.add("hidden");
  }
});

// LOGIN
function login(){
  auth.signInWithEmailAndPassword(email.value, pass.value)
  .catch(e=>alert(e.message));
}

// REGISTRO
function register(){
  auth.createUserWithEmailAndPassword(email.value, pass.value)
  .then(r=>{
    const uid = r.user.uid;
    cuenta = "CUENTA-" + Math.floor(Math.random()*900000+100000);
    tarjeta = "DEV-" + Math.floor(Math.random()*900000+100000);

    db.ref("usuarios/"+uid).set({ cuenta, score:50 });
    db.ref("cuentas/"+cuenta).set({ saldo:1000, totalRecibido:0 });
    db.ref("tarjetas/"+tarjeta).set({ cuenta });

    alert("Cuenta creada correctamente");
  })
  .catch(e=>alert(e.message));
}

// CARGAR DATOS
function cargarDatos(){
  db.ref("usuarios/"+uidActual).once("value").then(s=>{
    if(!s.exists()){
      alert("Error de datos. Vuelve a iniciar sesi√≥n.");
      logout();
      return;
    }
    cuenta = s.val().cuenta;
    scoreActual = s.val().score;
    score.innerText = scoreActual;

    db.ref("cuentas/"+cuenta+"/saldo")
      .on("value",v=>saldo.innerText=v.val()||0);

    db.ref("tarjetas")
      .orderByChild("cuenta")
      .equalTo(cuenta)
      .once("value")
      .then(r=>r.forEach(x=>tarjeta.innerText=x.key));

    cargarPrestamos();
    cargarHistorial();
  });
}

// ENVIAR DINERO
function enviar(){
  const d = destino.value;
  const m = parseInt(monto.value);
  if(!d || m<=0) return alert("Datos inv√°lidos");

  db.ref("tarjetas/"+d).once("value").then(t=>{
    if(!t.exists()) return alert("Tarjeta no existe");

    const cuentaDestino = t.val().cuenta;

    db.ref("cuentas/"+cuenta+"/saldo").once("value").then(s=>{
      if(s.val()<m) return alert("Saldo insuficiente");

      db.ref("cuentas/"+cuenta+"/saldo").set(s.val()-m);
      db.ref("cuentas/"+cuentaDestino+"/saldo")
        .transaction(v=>(v||0)+m);

      guardarHistorial("Env√≠o",m);
    });
  });
}

// PR√âSTAMO BANCO
function prestamoBanco(){
  const m = parseInt(bancoMonto.value);
  if(m<=0) return alert("Monto inv√°lido");

  const limite = scoreActual * 20;
  if(m>limite) return alert("Pr√©stamo denegado por score");

  const interes = m<=500?0.05:m<=1000?0.08:0.12;
  const deuda = Math.floor(m*(1+interes));

  db.ref("cuentas/"+cuenta+"/saldo")
    .transaction(v=>(v||0)+m);

  db.ref("prestamos/"+cuenta).push({
    monto:m,
    deuda:deuda,
    pagado:false
  });

  guardarHistorial("Pr√©stamo banco",m);
  cargarPrestamos();
}

// PR√âSTAMOS
function cargarPrestamos(){
  prestamos.innerHTML="";
  db.ref("prestamos/"+cuenta).once("value").then(s=>{
    if(!s.exists()){
      prestamos.innerHTML="<i>Sin pr√©stamos</i>";
      return;
    }
    Object.entries(s.val()).forEach(([id,p])=>{
      prestamos.innerHTML+=`
      <div class="item">
        Deuda: ${p.deuda}<br>
        Estado: ${p.pagado?'<span class="green">Pagado</span>':'<span class="red">Activo</span>'}
        ${!p.pagado?`<button onclick="pagar('${id}',${p.deuda})">Pagar</button>`:""}
      </div>`;
    });
  });
}

function pagar(id,m){
  db.ref("cuentas/"+cuenta+"/saldo").once("value").then(s=>{
    if(s.val()<m) return alert("Saldo insuficiente");
    db.ref("cuentas/"+cuenta+"/saldo").set(s.val()-m);
    db.ref("prestamos/"+cuenta+"/"+id+"/pagado").set(true);
    scoreActual+=5;
    score.innerText=scoreActual;
    guardarHistorial("Pago pr√©stamo",m);
    cargarPrestamos();
  });
}

// HISTORIAL
function guardarHistorial(d,m){
  db.ref("historial/"+cuenta).push({desc:d,m,fecha:Date.now()});
  cargarHistorial();
}

function cargarHistorial(){
  historial.innerHTML="";
  db.ref("historial/"+cuenta).once("value").then(s=>{
    if(!s.exists()){
      historial.innerHTML="<i>Vac√≠o</i>";
      return;
    }
    Object.values(s.val()).reverse().forEach(x=>{
      historial.innerHTML+=`<div class="item">${x.desc} - ${x.m}</div>`;
    });
  });
}

function borrarHistorial(){
  if(confirm("¬øBorrar historial?")){
    db.ref("historial/"+cuenta).remove();
    historial.innerHTML="<i>Vac√≠o</i>";
  }
}

function logout(){ auth.signOut(); }

function eliminarCuenta(){
  if(!confirm("Eliminar cuenta definitivamente?")) return;
  const u = auth.currentUser;
  db.ref("usuarios/"+u.uid).remove();
  db.ref("cuentas/"+cuenta).remove();
  db.ref("prestamos/"+cuenta).remove();
  db.ref("historial/"+cuenta).remove();
  db.ref("tarjetas/"+tarjeta).remove();
  u.delete().then(()=>alert("Cuenta eliminada"));
}
</script>

</body>
</html>
