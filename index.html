<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Banco Devito</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{background:#0b0b0b;color:white;font-family:Arial;margin:0;padding:15px;}
.card{border:1px solid #333;border-radius:10px;padding:15px;margin-bottom:15px;}
input,button{width:100%;padding:10px;margin-top:8px;border-radius:6px;border:none;}
button{background:#1e90ff;color:white;font-weight:bold;cursor:pointer;}
button.red{background:#ff4d4d;}
button.green{background:#00ff7f;}
.hidden{display:none;}
.item{border-bottom:1px solid #333;padding:8px 0;}
</style>
</head>
<body>

<h2>ğŸ¦ Banco Devito</h2>

<!-- LOGIN -->
<div id="loginBox" class="card">
  <input id="email" placeholder="Correo">
  <input id="pass" type="password" placeholder="PIN (mÃ­n. 6)">
  <button onclick="login()">Iniciar sesiÃ³n</button>
  <button onclick="register()">Crear cuenta</button>
</div>

<!-- BANCO -->
<div id="bankBox" class="hidden">

  <div class="card">
    <b>Saldo:</b> <span id="saldo">0</span> coins<br>
    <b>Tarjeta:</b> <span id="tarjeta"></span><br>
    <b>Score:</b> <span id="score">50</span>
  </div>

  <!-- ENVIAR DINERO -->
  <div class="card">
    <h3>ğŸ’¸ Enviar dinero</h3>
    <input id="destino" placeholder="DEV-XXXXXX">
    <input id="monto" type="number" placeholder="Monto">
    <button onclick="enviar()">Enviar</button>
  </div>

  <!-- PRESTAR A OTRO JUGADOR -->
  <div class="card">
    <h3>ğŸ¤ Prestar dinero a otro jugador</h3>
    <input id="prestDestino" placeholder="DEV-XXXXXX">
    <input id="prestMonto" type="number" placeholder="Monto">
    <input id="prestDias" type="number" placeholder="DÃ­as para devolver">
    <button onclick="prestar()">Prestar</button>
  </div>

  <!-- PRÃ‰STAMO DEL BANCO -->
  <div class="card">
    <h3>ğŸ¦ Solicitar prÃ©stamo del banco</h3>
    <input id="bancoMonto" type="number" placeholder="Monto">
    <button onclick="prestamoBanco()">Solicitar prÃ©stamo</button>
  </div>

  <!-- HISTORIAL -->
  <div class="card">
    <h3>ğŸ“„ Historial</h3>
    <div id="historial"></div>
  </div>

  <!-- PRÃ‰STAMOS -->
  <div class="card">
    <h3>ğŸ“‘ PrÃ©stamos activos</h3>
    <div id="prestamos"></div>
  </div>

  <button onclick="logout()">Cerrar sesiÃ³n</button>
  <button class="red" onclick="eliminarCuenta()">Eliminar cuenta</button>
</div>

<script>
// FIREBASE
firebase.initializeApp({
  apiKey: "AIzaSyDeUQx95EfJgmNeyh_L2Cnzqmm37emwJhw",
  authDomain: "bancodevito.firebaseapp.com",
  databaseURL: "https://bancodevito-default-rtdb.firebaseio.com",
  projectId: "bancodevito"
});

const auth=firebase.auth();
const db=firebase.database();

let cuenta="", tarjeta="";

// SESIÃ“N
auth.onAuthStateChanged(u=>{
  if(u){
    loginBox.classList.add("hidden");
    bankBox.classList.remove("hidden");
    cargarBanco(u.uid);
  }else{
    loginBox.classList.remove("hidden");
    bankBox.classList.add("hidden");
  }
});

// LOGIN / REGISTRO
function login(){
  auth.signInWithEmailAndPassword(email.value,pass.value).catch(e=>alert(e.message));
}

function register(){
  auth.createUserWithEmailAndPassword(email.value,pass.value)
  .then(r=>{
    const uid=r.user.uid;
    cuenta="CUENTA-"+Math.floor(100000+Math.random()*900000);
    db.ref("usuarios/"+uid).set({cuenta,score:50});
    db.ref("cuentas/"+cuenta).set({saldo:1000,totalRecibido:0});
    tarjeta="DEV-"+Math.floor(100000+Math.random()*900000);
    db.ref("tarjetas/"+tarjeta).set({cuenta});
    alert("Cuenta creada âœ”ï¸");
  }).catch(e=>alert(e.message));
}

// CARGAR BANCO
function cargarBanco(uid){
  db.ref("usuarios/"+uid).once("value").then(s=>{
    cuenta=s.val().cuenta;
    score.innerText=s.val().score||50;

    db.ref("cuentas/"+cuenta+"/saldo").on("value",v=>saldo.innerText=v.val()||0);

    db.ref("tarjetas").orderByChild("cuenta").equalTo(cuenta).once("value").then(r=>{
      r.forEach(x=>tarjeta=x.key);
      document.getElementById("tarjeta").innerText=tarjeta;
    });

    cargarHistorial();
    cargarPrestamos();
  });
}

// ENVIAR
function enviar(){
  const d=destino.value,m=parseInt(monto.value);
  if(!d||!m) return alert("Datos incompletos");
  db.ref("tarjetas/"+d).once("value").then(t=>{
    if(!t.exists()) return alert("Tarjeta invÃ¡lida");
    moverSaldo(t.val().cuenta,m,"Enviado a "+d);
  });
}

// MOVER SALDO
function moverSaldo(dest,m,desc){
  const ref=db.ref("cuentas/"+cuenta+"/saldo");
  ref.once("value").then(s=>{
    if(s.val()<m) return alert("Saldo insuficiente");
    ref.set(s.val()-m);
    db.ref("cuentas/"+dest+"/saldo").transaction(v=>(v||0)+m);
    db.ref("cuentas/"+dest+"/totalRecibido").transaction(v=>(v||0)+m);
    guardarHistorial(desc,m);
  });
}

// GUARDAR HISTORIAL
function guardarHistorial(desc,m){
  db.ref("historial/"+cuenta).push({desc,m,fecha:Date.now()});
  cargarHistorial();
}

function cargarHistorial(){
  historial.innerHTML="";
  db.ref("historial/"+cuenta).once("value").then(s=>{
    if(!s.exists()) return historial.innerHTML="<i>Sin movimientos</i>";
    Object.values(s.val()).reverse().forEach(x=>{
      historial.innerHTML+=`<div class="item">${x.desc} - ${x.m} coins</div>`;
    });
  });
}

// PRESTAR A OTRO JUGADOR
function prestar(){
  const d=prestDestino.value,m=parseInt(prestMonto.value),dias=parseInt(prestDias.value);
  if(!d||!m||!dias) return alert("Datos incompletos");
  db.ref("tarjetas/"+d).once("value").then(t=>{
    if(!t.exists()) return alert("Jugador invÃ¡lido");
    moverSaldo(t.val().cuenta,m,"PrÃ©stamo a "+d);
    db.ref("prestamos/"+t.val().cuenta).push({
      de:cuenta,m,dias,inicio:Date.now(),pagado:false
    });
    cargarPrestamos();
  });
}

// PRÃ‰STAMO BANCO CON LÃMITE Y PLAZO AUTOMÃTICO
function prestamoBanco(){
  const m=parseInt(bancoMonto.value);
  if(!m) return alert("Monto invÃ¡lido");

  db.ref("cuentas/"+cuenta).once("value").then(s=>{
    const saldo=s.val().saldo||0;
    const totalRecibido=s.val().totalRecibido||0;
    const score=50; // Puedes usar score real si quieres

    const maxPrestamo=Math.min(totalRecibido*2 || 1000, saldo*3 || 1000);
    if(m>maxPrestamo) return alert(`Monto excede el lÃ­mite mÃ¡ximo: ${maxPrestamo} coins`);

    let dias=7;
    if(m<=300) dias=3;
    else if(m<=700) dias=7;
    else dias=14;

    db.ref("cuentas/"+cuenta+"/saldo").transaction(v=>(v||0)+m);
    db.ref("prestamos/"+cuenta).push({
      de:"BANCO",m,dias,inicio:Date.now(),pagado:false
    });
    guardarHistorial("PrÃ©stamo del banco recibido",m);
    cargarPrestamos();
    bancoMonto.value="";
    alert(`PrÃ©stamo aprobado por ${m} coins. Debe devolverse en ${dias} dÃ­as`);
  });
}

// CARGAR PRÃ‰STAMOS
function cargarPrestamos(){
  prestamos.innerHTML="";
  db.ref("prestamos/"+cuenta).once("value").then(s=>{
    if(!s.exists()) return prestamos.innerHTML="<i>Sin prÃ©stamos</i>";
    Object.entries(s.val()).forEach(([id,p])=>{
      const estado=p.pagado?`<span class="green">âœ… Pagado</span>`:`âŒ Activo`;
      const fechaLimite=new Date(p.inicio + p.dias*24*60*60*1000).toLocaleDateString();
      prestamos.innerHTML+=`<div class="item">
        De: ${p.de}<br>
        Monto: ${p.m} coins<br>
        Plazo: ${p.dias} dÃ­as<br>
        Fecha lÃ­mite: ${fechaLimite}<br>
        Estado: ${estado}
        ${!p.pagado?`<br><button onclick="pagarPrestamo('${id}')">Pagar prÃ©stamo</button>`:""}
      </div>`;
    });
  });
}

// PAGAR PRÃ‰STAMO
function pagarPrestamo(id){
  db.ref("prestamos/"+cuenta+"/"+id).once("value").then(p=>{
    if(!p.exists()) return;
    const m=p.val().m;
    db.ref("cuentas/"+cuenta+"/saldo").once("value").then(s=>{
      if(s.val()<m) return alert("Saldo insuficiente");
      db.ref("cuentas/"+cuenta+"/saldo").set(s.val()-m);
      db.ref("prestamos/"+cuenta+"/"+id+"/pagado").set(true);
      guardarHistorial("Pago de prÃ©stamo "+p.val().de,m);
      cargarPrestamos();
    });
  });
}

// LOGOUT
function logout(){ auth.signOut(); }

// ELIMINAR CUENTA
function eliminarCuenta(){
  if(!confirm("Â¿Eliminar cuenta definitivamente?")) return;
  const u=auth.currentUser;
  db.ref("usuarios/"+u.uid).remove();
  db.ref("cuentas/"+cuenta).remove();
  db.ref("tarjetas/"+tarjeta).remove();
  db.ref("historial/"+cuenta).remove();
  db.ref("prestamos/"+cuenta).remove();
  u.delete().then(()=>alert("Cuenta eliminada âœ”ï¸"));
}
</script>

</body>
</html>
